jQuery(document).ready(function($){
    // ----------------------------------------------------
    // Login
    // ----------------------------------------------------
    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });

    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        var url = $("input[name='baseurl']").val();
        if (url.substr(-1) != "/") {
            url +=  "/";
        }
        url += "login/validate/";
        console.log(url);
        $.post(url, $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // localtion.href = "";
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }

        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    // ----------------------------------------------------
    // User
    // ----------------------------------------------------
    $("#user form").submit(function(){
        $("button").attr("disabled","true");
        // Validate
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // localtion.href = "";
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    $("div.datepick").datetimepicker({
        format:"yyyy-mm-dd hh:ii",
        autoclose: true,
        todayBtn: true,
        pickerPosition: "bottom-left"
    });

    // ----------------------------------------------------
    // Prebook
    // ----------------------------------------------------
    $("#prebook input[name='chk-username']").click(function(){
        if ($(this).is(":checked")) {
            $("#prebook input[name='username']").attr("readonly", "true").addClass(" uneditable-input");
        } else {
            $("#prebook input[name='username']").removeAttr("readonly").removeClass(" uneditable-input");
        }
    });

    $("#prebook form button[name='invalid']").click(function(){
        $("#prebook form").append('<input type="hidden" name="status" value="invalid" />');
        $("#prebook form").trigger("submit");
        $("#prebook form input[name='status'][type='hidden']").remove();
        return false;
    });
    $("#prebook form").submit(function(){
        $("button").attr("disabled","true");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // localtion.href = "";
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    // ----------------------------------------------------
    // Test page
    // ----------------------------------------------------
    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });
    $("#test select[name='color']").simplecolorpicker({picker: true});

    // File upload
    // ----------------------------------------------------
    function delimage($this) {
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $thumb = $("input[type='hidden'][name='base-thumb']:first").attr("value");
        var $name = $("img", $this.parent()).attr("src").replace($thumb, "");
        var $label = $('#albums span.label');
        var $that = $this;
        $.post($base + "/admin/car/delimage/" + $id, {name: $name}, function(out){
            if (out.status == 0) {
                $that.parent().hide("slow", function(){
                    $(this).remove();
                });
                $label.addClass("label-success").removeClass("label-important");
            } else {
                $label.addClass("label-important").remvoeClass("label-success");
            }
            $label.text(out.msg);
            setTimeout(function(){$label.text("");}, 2000);
        }, "json");
    }
    $("#myModal.upload").on("show", function() {
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $thumb = $("input[type='hidden'][name='base-thumb']:first").attr("value");
        var $process = $('div.progress');
        var $bar = $('div.progress .bar', $(this));
        var $label = $('span.label', $(this));
        $label.text("");
        $bar.css({width: '0%'});

        $('#upload').fileupload({
            url : $base + "/admin/car/upload/" + $id,
            dataType: 'json',
            autoUpload: true,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            maxNumberOfFiles: 1,
            fileInput: $(this),
            maxFileSize: 5000,
            previewMaxWidth : 200,
            previewMaxHeight : 200,
            add: function(e, data) {
                data.submit();
                $process.addClass('progress-success').removeClass('progress-danger');
            },
            formData: {},
            progressall: function (e, data) {
                var percent = parseInt(data.loaded / data.total * 100, 10);
                $bar.css('width', percent + '%');
            },
            done: function (e, data) {
                if (data.textStatus != "success" || data.result.status != 0){
                    $process.addClass('progress-danger').removeClass('progress-success');
                    data.result.msg && $label.text(data.result.msg).addClass("label-important").removeClass("label-success");
                } else {
                    var $albums = $("#albums .thumbnails");
                    var $li = $("<li />").addClass("span2");
                    var $span = $('<span class="icon-remove pull-right del"></span>').appendTo($li);
                    $("<img />").attr("src", $thumb + data.result.name).appendTo($li);

                    $li.appendTo($albums);
                    $span.click(function(){
                        delimage($(this));
                        return false;
                    });
                    $
                    data.result.msg && $label.text(data.result.msg).addClass("label-success").removeClass("label-important");
                    setTimeout(function(){$("#myModal.upload").modal("hide");}, 1000);
                }
            }
        });
    }).on("hidden", function(){
        $('#upload').fileupload('destroy');
    });
    $("#albums span.del").click(function(){
        delimage($(this));
        return false;
    });
    // ----------------------------------------------------

    $("#test form button[name='complete']").click(function(){
        $("#test form").append('<input type="hidden" name="status" value="finish" />');
        $("#test form").trigger("submit", true);
        $("#test form input[name='status'][type='hidden']").remove();
        return false;
    });
    $("#test form").submit(function($test){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                if ($test) {
                    location.href = $base + "/admin/car/test/" + ($id+1) + "/edit";
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    // ----------------------------------------------------
    // Auction
    // ----------------------------------------------------
    $("#auction #myModal").on("show", function() {
        $("#auction form").append('<input type="hidden" name="status" value="finish" />');
    }).on("hidden", function(){
        $("#auction form input[name='status'][type='hidden']").remove();
    });
    $("#auction form").submit(function(){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if ($("#auction input[name='status']").length > 0) {
                $msg = $("#modal-msg");
                $test = false;
            } else {
                $msg = $("#msg");
                $test = true;
            }
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                if ($test) {
                    location.href = $base + "/admin/car/test/" + $id + "/edit";
                } else {
                    location.href = $base + "/admin/car/auction/";
                }
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    // ----------------------------------------------------
    // Article
    // ----------------------------------------------------
    var $base = $("#article input[name='base'][type='hidden']").attr("value");
    if ($("#inputContent").length > 0) {
        CKEDITOR && CKEDITOR.replace("inputContent", {
            height: 300,
            language: 'zh-cn',
            filebrowserBrowseUrl:      $base + 'assets/editor/ckfinder/ckfinder.html',
            filebrowserImageBrowseUrl: $base + 'assets/editor/ckfinder/ckfinder.html?Type=Images',
            filebrowserFlashBrowseUrl: $base + 'assets/editor/ckfinder/ckfinder.html?Type=Flash',
            filebrowserUploadUrl:      $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Files',
            filebrowserImageUploadUrl: $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Images',
            filebrowserFlashUploadUrl: $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Flash'
        });
    }
    $("#article form").submit(function(){
        $("button").attr("disabled","true");
        // Get editor data
        $("#inputContent").val(CKEDITOR.instances.inputContent.getData());
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            $msg = $("#msg");
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

});
