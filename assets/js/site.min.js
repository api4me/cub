jQuery(document).ready(function($){
    /* Common setting
    --------------------------------*/
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6]/i)) {
        $("#logo").before('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE7及其以上版本</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }

    var url = $("#baseurl").val();
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 40;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        //jQuery("body").append('<div class="feedback"><a href="#" title="建议反馈" target="_blank"></a></div>');
        jQuery(".feedback").css("right", _w);
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();
    $("form.s div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("form.s div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    (function () {
        $(".countdown").each(function(){
            var d = new Date(Date.parse($(this).html().replace(/-/g, "/")));
            $(this).countdown(d, function(event) {
                // Update every second one time only
                if(event.type != "seconds") return;
                // Calculate the time left
                var timeLeft = [
                    event.lasting.hours + event.lasting.days * 24,
                    event.lasting.minutes,
                    event.lasting.seconds
                ];
                // Convert the number to two digits strings
                for(var i = 0; i < timeLeft.length; ++i) {
                    timeLeft[i] = (timeLeft[i] < 10 ? '0' : '') + timeLeft[i].toString();
                }
                // Concatenate the strings with : and update the html
                $(this).html(timeLeft.join(':'));
            });
        });
    })();

    /* Login
    --------------------------------*/
    $("#login div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("#login div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });
    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        $.post(url + "/login/validate/", $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //location.replace(data.url ? data.url : url);
                location.href = data.url || url;
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }

        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    /* Probook
    --------------------------------*/
    $("#prebook-form").submit(function(){
        $that = $(this);
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                setTimeout(function(){
                    $that.get(0).reset();
                    $("#msg").removeClass("alert in").text("");
                }, 3000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                $("button").removeAttr("disabled");
            }
        }, "json");

        return false;
    });
    /* Buy
    --------------------------------*/
    $('.tooltip-show').tooltip({
        selector: "a[data-toggle=tooltip]"
    }).click(function(e) {
        e.preventDefault();
    });

    /* Search
    --------------------------------*/
    $(window).scroll(function(){
        var scrTop = $(this).scrollTop();
        if ($(".form-search").length > 0) {
            offTop = $(".form-search").offset().top+38;
            scrTop>offTop ? $("#scroll").addClass("tagsFix") : $("#scroll").removeClass("tagsFix");
        }
    });

    $("form.s").submit(function(){
        var q = $("input[name='q']").val();
        location.href = url + "/buy/search/?q=" + q;
        return false;
    });
    $("form.search").submit(function(){
        var q = $("input[name='search']").val();
        location.href = url + "/buy/search/?q=" + q;
        return false;
    });

    /* Buy car
    --------------------------------*/
    $fmt = function(num) {
        if (num) {
            if (num.length > 4) {
                return num.substr(0, num.length-4) + '万' + num.substr(-4);
            }
        }
        return num;
    }
    $("#buy-car #price").focus(function(){
        $(this).css({imeMode:'disabled'});
        if ($(this).val()) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".auction-preview").removeClass("hide").html($fmt($(this).val())).css({top: top, left: left});
        }
    }).keypress(function(e){
        if ((e.keyCode > 47) && (e.keyCode < 58)) {
            return true;
        }
        return false;
    }).keyup(function(){
        var $p = $(this).val().replace(/[^\d]*/g, '');
        
        if ($p) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".auction-preview").removeClass("hide").html($fmt($p)).css({top: top, left: left});
        } else {
            $(".auction-preview").addClass("hide").html($p);
        }
    }).blur(function(){
        $(".auction-preview").addClass("hide");
    }).next().click(function(){
        var id = $("input[name='id']").val();
        var p = $(this).prev().val().replace(/[^\d]*/g, '');
        var v = CryptoJS.MD5(id.toString()+p.toString()).toString();
        $.post(url + "/buy/pay", {id: id, p: p, v: v}, function(data){
            alert(data.msg);
        });
    });
});

