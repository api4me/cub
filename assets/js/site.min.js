jQuery(document).ready(function($){
    /* Common setting
    --------------------------------*/
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6]/i)) {
        $("#logo").before('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE7及其以上版本</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }

    var url = $("#baseurl").val();
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;" title="返回页面顶部"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 140;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        jQuery("body").append('<div class="online"><a target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=123341993&site=qq&menu=yes" title="点击联系在线客服"></a></div>');
        jQuery(".online").css("right", _w);
        //jQuery("body").append('<div class="feedback"><a target="_blank" href="#" title="意见反馈"></a></div>');
        //jQuery(".feedback").css("right", _w);
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();
    $("form.s div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("form.s div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    (function () {
        $(".countdown").each(function(){
            var d = new Date(Date.parse($(this).html().replace(/-/g, "/")));
            $(this).countdown(d, function(event) {
                // Update every second one time only
                if(event.type != "seconds") return;
                // Calculate the time left
                var timeLeft = [
                    event.lasting.hours + event.lasting.days * 24,
                    event.lasting.minutes,
                    event.lasting.seconds
                ];
                // Convert the number to two digits strings
                for(var i = 0; i < timeLeft.length; ++i) {
                    timeLeft[i] = (timeLeft[i] < 10 ? '0' : '') + timeLeft[i].toString();
                }
                // Concatenate the strings with : and update the html
                $(this).html(timeLeft.join(':'));
            });
        });
    })();
    $('.carousel').carousel();

    /* Login
    --------------------------------*/
    $("#login div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("#login div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });
    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        $.post(url + "/login/validate/", $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //location.replace(data.url ? data.url : url);
                location.href = data.url || url;
            } else {
                $("#login #p-captcha>img").trigger("click");
                $("#login input[name='captcha']").val("");
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // Load capacha
                if ($('#login #p-captcha').length == 0) {
                    $('#login form input[name="pwd"]').parent().after('<p class="help-block" id="p-captcha">'+
                            '<img src="'+ url +'/captcha/?t='+ (new Date()).toString() +'" id="image-captcha"/><span class="btn btn-link" id="span-captcha" >看不清，换一张</span>'+
                        '</p>'+
                        '<div class="block">'+
                            '<input type="text" class="input-block-level" name="captcha" autocomplete="off">'+
                            '<label class="tip">验证码</label>'+
                        '</div>');
                }
            }
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    });

    /* Probook
    --------------------------------*/
    $("#prebook-form").submit(function(){
        $that = $(this);
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                setTimeout(function(){
                    $that.get(0).reset();
                    $("#msg").removeClass("alert in").text("");
                }, 3000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                $("button").removeAttr("disabled");
            }
        }, "json");

        return false;
    });
    /* Buy
    --------------------------------*/
    $('.tooltip-show').tooltip({
        selector: "a[data-toggle=tooltip]"
    }).click(function(e) {
        e.preventDefault();
    });

    /* Search
    --------------------------------*/
    $(window).scroll(function(){
        var scrTop = $(this).scrollTop();
        if ($(".form-search").length > 0) {
            offTop = $(".form-search").offset().top+38;
            scrTop>offTop ? $("#scroll").addClass("tagsFix") : $("#scroll").removeClass("tagsFix");
        }
    });

    $("form.s").submit(function(){
        var q = $.trim($("input[name='q']").val());
        if (q.length > 0) {
            location.href = url + "/buy/search/?q=" + q;
        }
        return false;
    });
    $("form.search").submit(function(){
        var q = $.trim($("input[name='search']").val());
        if (q.length > 0) {
            location.href = url + "/buy/search/?q=" + q;
        }
        return false;
    });

    /* Buy car
    --------------------------------*/
    $fmt = function(num) {
        if (num) {
            if (num.length > 4) {
                return num.substr(0, num.length-4) + '万' + num.substr(-4);
            }
        }
        return num;
    }
    $("#buy-car #price").focus(function(){
        $(this).css({imeMode:'disabled'});
        if ($(this).val()) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".auction-preview").removeClass("hide").html($fmt($(this).val())).css({top: top, left: left});
        }
    }).keypress(function(e){
        if ((e.keyCode > 47) && (e.keyCode < 58)) {
            return true;
        }
        return false;
    }).keyup(function(){
        var $p = $(this).val().replace(/[^\d]*/g, '');
        
        if ($p) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".auction-preview").removeClass("hide").html($fmt($p)).css({top: top, left: left});
        } else {
            $(".auction-preview").addClass("hide").html($p);
        }
    }).blur(function(){
        $(".auction-preview").addClass("hide");
    }).next().click(function(){
        var id = $("input[name='id']").val();
        var p = $(this).prev().val().replace(/[^\d]*/g, '');
        var v = CryptoJS.MD5(id.toString()+p.toString()).toString();
        $("button").attr("disabled","true");
        $.post(url + "/buy/pay", {id: id, p: p, v: v}, function(data){
            if (data.status != 0) {
                alert(data.msg);
            } else {
                if (data.data) {
                    var $m = $("#buy-car #pay-modal");
                    var $b = $("tbody", $m).html('');
                    $.each(data.data, function(i, d){
                        $('<tr><td>第' + (i+1).toString() + '名</td><td>' + d.name + '</td><td>' + d.price + '</td><td>' + d.area + '</td></tr>').appendTo($b);
                    });
                    $m.modal('show');
                } else {
                    alert(data.msg);
                }
            }
            $("button").removeAttr("disabled");
        });
    });

    $("#buy-car div.carousel .carousel-magnifier").click(function(){
        var $m = $("#buy-car #carousel-modal");
        var $img = $('<img />').attr('src', $("div.carousel-inner div.active img").attr('src'));
        $(".modal-body", $m).html($img).css({'max-height': '800px'});
        $m.modal('toggle').css({'width': '800px', 'margin-left': function () {return -($(this).width() / 2);}})
        $m.modal("show");
        return false;
    });
    /* User
    --------------------------------*/
    $("#user tr.modify-pwd button").click(function(){
        $("#user div.modify-pwd-pannel").show(200);
        $("html, body").animate({scrollTop: $(document).height()}, 200);
    });
    $("#user div.modify-pwd-pannel button[type='reset']").click(function(){
        $("#user div.modify-pwd-pannel").hide(200);
    });
    $("#user div.modify-pwd-pannel form").submit(function(){
        var $ori = $.trim($("input[name='pwd-ori']", $(this)).val());
        var $pwd = $.trim($("input[name='pwd-new']", $(this)).val());
        var $pwda = $.trim($("input[name='pwd-new-again']", $(this)).val());
        if ($ori.length == 0) {
            $("#msg").attr("class","alert alert-block alert-error fade in");
            $("#msg").text("请输入原密码");
            $("#msg").alert();
            return false;
        } 
        if ($pwd.length == 0) {
            $("#msg").attr("class","alert alert-block alert-error fade in");
            $("#msg").text("请输入新密码");
            $("#msg").alert();
            return false;
        } 
        if ($pwda.length == 0) {
            $("#msg").attr("class","alert alert-block alert-error fade in");
            $("#msg").text("请再次确认新密码");
            $("#msg").alert();
            return false;
        } 
        if ($pwd != $pwda) {
            $("#msg").attr("class","alert alert-block alert-error fade in");
            $("#msg").text("密码输入不一致");
            $("#msg").alert();
            return false;
        }
        $("button").attr("disabled","true");

        var h = CryptoJS.MD5(CryptoJS.MD5($ori).toString() + $pwd).toString();
        $.post(url + "/user/pwd/", {p: $pwd, h: h}, function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    $('#user span.pay-modal').click(function(){
        var id = $(this).attr('data-id');
        $.get(url + '/user/top/' + id, function(data){
            if (data.data) {
                var $m = $("#user #pay-modal");
                var $b = $("tbody", $m).html('');
                $.each(data.data, function(i, d){
                    $('<tr><td>第' + (i+1).toString() + '名</td><td>' + d.name + '</td><td>' + d.price + '</td><td>' + d.area + '</td></tr>').appendTo($b);
                });
                $m.modal('show');
            } else {
                alert(data.msg);
            }

        });
    });
});

